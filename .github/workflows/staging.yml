# This is a basic workflow to help you get started with Actions

name: staging

on:
    push:
        branches: ["development"]
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Publish Latest to Registry
              uses: elgohr/Publish-Docker-Github-Action@master
              with:
                  name: KATITB22/Backend/development
                  username: ${{ secrets.PKG_REGISTRY_USERNAME }}
                  password: ${{ secrets.PKG_REGISTRY_PASSWORD }}
                  registry: docker.pkg.github.com
                  tags: "latest"
            - name: Deployment
              uses: cross-the-world/ssh-scp-ssh-pipelines@latest
              with:
                  host: ${{ secrets.STAGING_HOST_ADDRESS }}
                  user: ${{ secrets.STAGING_HOST_USERNAME }}
                  pass: ${{ secrets.STAGING_HOST_PASSWORD }}
                  connect_timeout: 10s
                  first_ssh: |
                      cd server
                      docker-compose pull
                      docker-compose up -d --remove-orphans
                      docker image prune -f
            - name: Backend Status
              uses: lakuapik/gh-actions-http-status@v1
              with:
                  sites: '["https://api.staging.katitb22.com"]'
                  expected: "[200]"
